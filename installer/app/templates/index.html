<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EpicStaff Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    
</head>
<body>
    <div class="toast" id="toast"></div>
    <div class="grid-container">
        <header class="header">
            <h1>EpicStaff Manager</h1>
        <div class="status">
                <span id="status-text">Checking system status...</span>
            <div id="indicator" class="indicator updating"></div>
            </div>
        </header>

        <div class="action-panel">
            <div class="buttons">
                <button id="update-button" class="button update" onclick="updateImages()">Update System</button>
                <button id="run-button" class="button" onclick="runDockerCompose()">Start System</button>
                <button id="stop-button" class="button stop" onclick="stopDockerCompose()">Stop System</button>
            </div>

            <button id="redirect-button" class="redirect-button" onclick="redirectToProjects()" disabled>
                Open Application
            </button>
            <div class="state-label">
                <h5>State:</h5>
                <h5 id="state-text">Initializing...</h5>
            </div>

            <!-- Volume Management Section -->
            <div class="volume-section">
                <h3>Database Volume Management</h3>
                <div class="volume-buttons">
                    <button id="export-volume-button" class="button" onclick="exportVolume()">
                        Export Database
                    </button>
                    <button id="import-volume-button" class="button" onclick="triggerImportVolume()">
                        Import Database
                    </button>
                    <input type="file" id="volume-import-input" accept=".tar" style="display: none;" onchange="importVolume()">
                </div>
            </div>

            <div class="savefiles-section">
                <h3>Data Storage Location</h3>
                <div class="flex items-center margin-top-2">
                    <input type="text" id="saveLocation" name="saveLocation"
                        class="input"
                        value="{{ savefiles_path }}"
                        {% if location_type == 'select' %}readonly{% endif %}>

                    {% if location_type == 'select' %}
                        <button type="button" onclick="selectFolder()"
                                class="save-button">
                            Select
                        </button>
                    {% elif location_type == 'input' %}
                        <button type="button" onclick="saveFolder()"
                                class="save-button">
                            Save Location
                        </button>
                    {% endif %}
                </div>
                <h3>Update Source</h3>
                <div class="flex items-center margin-top-2">
                    <input type="text" id="imageRepository" name="imageRepository" 
                        class="input"
                        value="{{ image_repository }}">
                    <button type="button" onclick="saveImageRepository()"
                        class="save-button">
                        Save Components Source
                    </button>
                </div>
                <div class="flex items-center margin-top-2">
                    <input type="text" id="imageTag" name="imageTag" 
                        class="input"
                        value="{{ image_tag }}">
                    <button type="button" onclick="saveImageTag()"
                        class="save-button">
                        Save Components Tag
                    </button>
                </div>
            </div>
        </div>
        
        <div class="containers-panel">
            <h3>System Components</h3>
            <div class="container-actions">
            </div>
            <table class="containers-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Status</th>
                        <th>ID</th>
                        <th>Started</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="containers-body">
                    <!-- Container rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="logs-panel">
            <div class="logs-header">
                <h3>System Logs</h3>
                <button id="clear-logs-button" class="button stop" onclick="clearLogs()">Clear Logs</button>
            </div>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let logContainer = document.getElementById('logs');
        let socket = null;
        let reconnect = false;
        const VOLUME_NAME = 'crew_pgdata';

        function connectSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Socket.IO connected');
                // Request initial data
                socket.emit('get_containers');
                socket.emit('check_containers');
                socket.emit('get_state');
            });

            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                updateContainersTable([]);
                updateHealthStatus([]);
                logMessage('Disconnected from server. Please check your connection.');
            });

            socket.on('containers', function(data) {
                updateContainersTable(data);
                updateHealthStatus(data);
            });

            socket.on('state', function(data) {
                updateState(data);
            });

            socket.on('update_log', function(message) {
                logMessage(message);
            });

            socket.on('action_success', function(message) {
                showToast(message);
                socket.emit('get_containers');
            });

            socket.on('action_error', function(message) {
                showToast(message, true);
            });

            socket.on('folder_selected', function(data) {
                if (data.success) {
                    document.getElementById('saveLocation').value = data.path;
                    showToast('Folder selected successfully. Please restart the system to apply changes.', false);
                } else {
                    showToast('Failed to select folder: ' + data.error, true);
                }
            });
            socket.on('image_repository_saved', function(data) {
                if (data.success) {
                    showToast('Component source changed', false);
                } else {
                    showToast('Invalid component source ' + data.error, true);
                }
            });
            socket.on('image_tag_saved', function(data) {
                if (data.success) {
                    showToast('Component tag changed', false);
                } else {
                    showToast('Invalid component tag ' + data.error, true);
                }
            });
        }

        function showLogs() {
            logContainer.textContent = localStorage.getItem('logs') || '';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function logMessage(message) {
            logs = localStorage.getItem('logs');
            if (logs == null) {
                logs = '';
            }
            datetime = new Date().toLocaleString();
            message = datetime + ' - ' + message;
            logs += message + '\n';
            logContainer.textContent += logs;
            localStorage.setItem('logs', logs);
            showLogs();
        }

        function clearLogs() {
            localStorage.removeItem('logs');
            logContainer.textContent = '';
        }

        function updateImages() {
            logMessage('Updating system components...');
            socket.emit('update_images');
        }

        function runDockerCompose() {
            logMessage('Starting system...');
            socket.emit('run_project');
        }

        function redirectToProjects() {
            window.open('http://127.0.0.1:4200/projects', '_blank');
        }

        function updateState(data) {
            const stateText = document.getElementById('state-text');
            if (data.state === 'default') {
                stateText.innerText = 'Default';
                document.getElementById('run-button').disabled = false;
                document.getElementById('stop-button').disabled = false;
            } else if (data.state === 'update_images') {
                stateText.innerText = 'Updating Images';
                document.getElementById('run-button').disabled = true;
                document.getElementById('stop-button').disabled = true;
            } else if (data.state === 'manage_project') {
                stateText.innerText = 'Running';
                document.getElementById('run-button').disabled = true;
                document.getElementById('stop-button').disabled = false;
            }
            else if (data.state === 'stop_container') {
                stateText.innerText = 'Stopping Container';
                document.getElementById('run-button').disabled = true;
                document.getElementById('stop-button').disabled = false;
            } 
            else {
                stateText.innerText = 'Unknown State';
                document.getElementById('run-button').disabled = false;
                document.getElementById('stop-button').disabled = false;
            }
        }

        function updateHealthStatus(data) {
            const statusText = document.getElementById('status-text');
            const indicator = document.getElementById('indicator');
            const redirectButton = document.getElementById('redirect-button');
            healthy = 0;
            data.forEach(element => {
                if (element.health == "healthy"){
                    healthy += 1;
                }
            });

            if (healthy >= 2) {
                statusText.innerText = 'System is ready!';
                indicator.className = 'indicator healthy';
                redirectButton.style.display = 'inline-block';
                redirectButton.disabled = false;
            } else {
                statusText.innerText = 'System is not ready yet.';
                indicator.className = 'indicator unhealthy';
                redirectButton.style.display = 'none';
            }
        }

        function updateContainersTable(containers) {
            const tbody = document.getElementById('containers-body');
            tbody.innerHTML = '';
            
            containers.forEach(container => {
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = container.name;
                row.appendChild(nameCell);
                
                // Status
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = container.status;
                statusSpan.className = `container-status ${getStatusClass(container.status)}`;
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // ID
                const idCell = document.createElement('td');
                idCell.textContent = container.id;
                row.appendChild(idCell);
                
                // Created
                const createdCell = document.createElement('td');
                createdCell.textContent = formatDate(container.started_at);
                row.appendChild(createdCell);

                // Actions
                const actionsCell = document.createElement('td');
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'action-buttons';

                const stopButton = document.createElement('button');
                stopButton.className = 'action-button stop-button';
                stopButton.textContent = 'Stop';
                stopButton.onclick = () => {
                    stopButton.disabled = true;
                    logMessage(`Stopping ${container.name}...`);
                    stopContainer(container.id, container.name);
                };
                stopButton.disabled = container.status === 'exited';
                actionsDiv.appendChild(stopButton);

                const restartButton = document.createElement('button');
                restartButton.className = 'action-button restart-button';
                restartButton.textContent = 'Restart';
                restartButton.onclick = () => {
                    restartButton.disabled = true;
                    logMessage(`Restarting ${container.name}...`);
                    restartContainer(container.id, container.name);
                };
                actionsDiv.appendChild(restartButton);

                actionsCell.appendChild(actionsDiv);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function stopContainer(containerId, containerName) {
            socket.emit('stop_container', { container_id: containerId });
        }

        function restartContainer(containerId, containerName) {
            socket.emit('restart_container', { container_id: containerId });
        }

        function stopDockerCompose() {
            if (!confirm('Are you sure you want to stop the system? This will stop all running components.')) {
                return;
            }
            logMessage('Stopping system...');
            socket.emit('stop_project');
        }

        async function selectFolder() {
            socket.emit('select_folder');
        }

        async function saveFolder() {
            const saveLocation = document.getElementById('saveLocation').value;
            if (saveLocation.trim() === '') {
                showToast('Please enter a valid save location.', true);
                return;
            }
            socket.emit('save_folder', { path: saveLocation });
        }

        async function saveImageRepository() {
            const image_repository = document.getElementById('imageRepository').value;
            if (image_repository.trim() === '') {
                showToast('Please enter a valid image repository.', true);
                return;
            }
            socket.emit('save_image_repository', { image_repository: image_repository });
        }

        async function saveImageTag() {
            const image_tag = document.getElementById('imageTag').value;
            if (image_tag.trim() === '') {
                showToast('Please enter a valid image tag.', true);
                return;
            }
            socket.emit('save_image_tag', { image_tag: image_tag });
        }

        // Volume Management Functions
        function exportVolume() {
            if (!confirm('Are you sure you want to export the database volume? This may take a few moments.')) {
                return;
            }
            
            logMessage('Exporting database volume...');
            showToast('Starting database export...', false);
            
            // Create a temporary link to download the volume
            const downloadUrl = `/export-volume/${VOLUME_NAME}/download`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${VOLUME_NAME}.tar`;
            link.style.display = 'none';
            document.body.appendChild(link);
            
            // Add event listeners to handle download success/failure
            link.addEventListener('click', function() {
                setTimeout(() => {
                    logMessage('Database volume export completed');
                    showToast('Success! Wait for download complete', false);
                    document.body.removeChild(link);
                }, 1000);
            });
            
            link.click();
        }

        function triggerImportVolume() {
            const fileInput = document.getElementById('volume-import-input');
            fileInput.click();
        }

        function importVolume() {
            const fileInput = document.getElementById('volume-import-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('No file selected for import', true);
                return;
            }
            
            if (!file.name.endsWith('.tar')) {
                showToast('Please select a .tar file', true);
                return;
            }
            
            if (!confirm('Are you sure you want to import this database volume? This will replace all existing data!')) {
                fileInput.value = '';
                return;
            }
            
            logMessage('Importing database volume...');
            showToast('Starting database import...', false);
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch(`/import-volume/${VOLUME_NAME}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    logMessage(`Database import failed: ${data.error}`);
                    showToast(`Import failed: ${data.error}`, true);
                } else {
                    logMessage('Database volume import completed successfully');
                    showToast('Database imported successfully!', false);
                }
            })
            .catch(error => {
                logMessage(`Database import error: ${error.message}`);
                showToast(`Import error: ${error.message}`, true);
            })
            .finally(() => {
                fileInput.value = '';
            });
        }

        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'running':
                    return 'status-running';
                case 'exited':
                    return 'status-exited';
                case 'created':
                    return 'status-created';
                case 'paused':
                    return 'status-paused';
                default:
                    return '';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        logContainer.textContent = localStorage.getItem('logs') || '';

        // Initialize Socket.IO connection
        connectSocket();
    </script>
</body>
</html>