<!-- chat-messages.component.html with trackBy added -->
<div class="chat-messages">
  <div *ngIf="!this.consoleService.isConversationConnected()" class="awaiting-connection">
    awaiting connection...
  </div>

  <div
    class="message-group"
    *ngFor="let group of groupedMessages(); trackBy: trackByGroupId"
    [ngClass]="group.role === 'user' ? 'message-user' : 'message-assistant'"
  >
    <div class="message-role">
      {{ group?.role === "user" ? "You" : agent?.role || "Assistant" }}
    </div>

    <div class="message-content">
      <div
        *ngFor="let item of group.items; trackBy: trackByItemId"
        class="message-item"
      >
        <!-- Tool Call -->
        <div *ngIf="item.formatted?.tool" class="message-text tool-call">
          {{ item.formatted.tool?.name }}({{ item.formatted.tool?.arguments }})
        </div>

        <!-- Tool Response -->
        <div
          *ngIf="item.type === 'function_call_output'"
          class="message-text tool-response"
        >
          <div
            class="tool-response-header"
            (click)="toggleResponseVisibility(item.id)"
          >
            <i
              class="ti ti-player-play-filled"
              [ngClass]="{ expanded: isResponseExpanded(item.id) }"
            ></i>
            <span>Output</span>
          </div>
          <div
            class="tool-response-content"
            *ngIf="isResponseExpanded(item.id)"
          >
            {{ item.formatted.output }}
          </div>
        </div>

        <!-- Regular User Message -->
        <div
          *ngIf="
            item.role === 'user' &&
            item.type === 'message' &&
            !item.formatted?.tool
          "
          class="message-text"
        >
          <span
            [ngClass]="{
              inaudible: getDisplayUserText(item) === '[inaudible]',
              'awaiting-transcript':
                getDisplayUserText(item) === '(awaiting transcript)'
            }"
          >
            {{ getDisplayUserText(item) }}
          </span>
        </div>

        <!-- Regular Assistant Message with Markdown -->
        <div
          *ngIf="
            item.role === 'assistant' &&
            item.type === 'message' &&
            !item.formatted?.tool
          "
          class="message-text markdown-content"
        >
          <markdown
            *ngIf="item.formatted?.transcript || item.formatted?.text"
            [data]="getAssistantText(item)"
            [inline]="false"
          ></markdown>
          <span *ngIf="!item.formatted?.transcript && !item.formatted?.text">
            (truncated)
          </span>
        </div>
      </div>
    </div>

    <div class="timestamp">{{ group.timestamp }}</div>
  </div>
</div>
