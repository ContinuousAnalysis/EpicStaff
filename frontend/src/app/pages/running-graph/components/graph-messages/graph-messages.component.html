<!-- graph-messages.component.html -->
<div class="messages-container">
  <!-- Connection status indicator -->
  <div
    class="connection-status"
    *ngIf="
      connectionStatus === 'reconnecting' || connectionStatus === 'disconnected'
    "
  >
    <div class="status-indicator" [class]="connectionStatus">
      <span class="status-icon">
        <i
          class="ti"
          [class.ti-loader]="connectionStatus === 'reconnecting'"
          [class.ti-alert-triangle]="connectionStatus === 'disconnected'"
          [class.ti-spin]="connectionStatus === 'reconnecting'"
        >
        </i>
      </span>
      <span class="status-text">
        <ng-container [ngSwitch]="connectionStatus">
          <span *ngSwitchCase="'reconnecting'">Reconnecting...</span>
          <span *ngSwitchCase="'disconnected'">Connection lost</span>
        </ng-container>
      </span>
    </div>
  </div>

  <!-- Messages list -->
  <div class="messages-list" *ngIf="this.sseService.messages().length > 0">
    @for (message of this.sseService.messages(); track message.uuid; let i =
    $index) {
    <div
      class="message"
      [class.inside-subflow]="isInsideSubflow(message, i)"
      [class.subflow-level-0]="getSubflowLevel(message, i) === 0"
      [class.subflow-level-1]="getSubflowLevel(message, i) === 1"
      [class.subflow-level-2]="getSubflowLevel(message, i) === 2"
      [class.subflow-level-3]="getSubflowLevel(message, i) === 3"
      [class.subflow-level-4]="getSubflowLevel(message, i) >= 4"
      [class.subflow-boundary]="
        message.message_data.message_type === 'subgraph_start' ||
        message.message_data.message_type === 'subgraph_finish'
      "
      [attr.data-subflow-level]="getSubflowLevel(message, i)"
    >
      <!-- Subflow connector lines wrapper -->
      <div
        class="subflow-connector"
        *ngIf="isInsideSubflow(message, i)"
        [class.subflow-level-1]="getSubflowLevel(message, i) === 1"
        [class.subflow-level-2]="getSubflowLevel(message, i) === 2"
        [class.subflow-level-3]="getSubflowLevel(message, i) === 3"
        [class.subflow-level-4]="getSubflowLevel(message, i) >= 4"
      ></div>
      <app-project-transition
        *ngIf="shouldShowTransition(message, i)"
      ></app-project-transition>

      @switch (message.message_data.message_type) { @case ('start') {
      <app-start-message [message]="message"></app-start-message>
      } @case ('user') {
      <app-user-message [message]="message"></app-user-message>
      } @case ('agent') {
      <app-agent-message
        [message]="message"
        [agent]="getAgentFromMessage(message)"
      ></app-agent-message>
      } @case ('agent_finish') {
      <app-agent-finish-message
        [message]="message"
        [agent]="getAgentFromMessage(message)"
      ></app-agent-finish-message>
      } @case ('python') {
      <app-python-message [message]="message"></app-python-message>
      } @case ('llm') {
      <app-llm-message [message]="message"></app-llm-message>
      } @case ('extracted_chunks') {
      <app-extracted-chunks-message
        [message]="message"
      ></app-extracted-chunks-message>
      } @case ('error') {
      <app-error-message [message]="message"></app-error-message>
      } @case ('task') {
      <app-task-message [message]="message"></app-task-message>
      } @case ('finish') {
      <app-finish-message
        [message]="message"
        [project]="getProjectFromMessage(message)"
      ></app-finish-message>
      } @case ('subgraph_start') {
      <app-subgraph-start-message [message]="message"></app-subgraph-start-message>
      } @case ('subgraph_finish') {
      <app-subgraph-finish-message [message]="message"></app-subgraph-finish-message>
      } }
    </div>
    }
  </div>

  <!-- Loading dots for running session -->
  <app-loading-dots
    *ngIf="isProcessing"
    class="loading-indicator"
  ></app-loading-dots>

  <!-- Waiting for user input component -->
  <app-wait-for-user-input
    *ngIf="statusWaitForUser"
    (messageSubmitted)="onUserMessageSubmitted($event)"
  ></app-wait-for-user-input>
</div>
