name: Deploy on self-hosted

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy to test3"
        required: true
        default: "main"

concurrency:
  group: epicstaff-deploy
  cancel-in-progress: false

jobs:
  deploy_test_2:
    name: Deploy to test_2 (auto from main)
    if: ${{ github.event_name == 'push' }}
    runs-on: [self-hosted, test_2]

    steps:
      - name: Deploy main to test_2
        shell: bash
        run: |
          set -euo pipefail
          cd /home/developer/EpicStaff
          git fetch --prune
          git checkout main
          git pull --ff-only origin main
          bash .github/scripts/deploy.sh main

  deploy_test_3:
    name: Deploy to test_3 (manual branch)
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted, test_3]

    steps:
      - name: Deploy selected branch to test_3
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.inputs.branch }}"
          cd /home/developer/EpicStaff
          git fetch --prune
          git checkout "$BRANCH"
          git pull --ff-only origin "$BRANCH"
          bash .github/scripts/deploy.sh "$BRANCH"
