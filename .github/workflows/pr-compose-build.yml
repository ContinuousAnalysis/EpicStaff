name: PR - build images from compose (src)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read

env:
  COMPOSE_FILE: src/docker-compose.yaml
concurrency:
  group: pr-${{ github.event.pull_request.number }}-compose-build
  cancel-in-progress: true

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate compose config json
        shell: bash
        run: |
          set -euo pipefail
          REPO_ROOT="$(pwd)"
          docker compose -f "$REPO_ROOT/$COMPOSE_FILE" config --format json > "$REPO_ROOT/compose.json"
          ls -la "$REPO_ROOT/compose.json"

      - name: Generate matrix (python)
        id: gen
        run: |
          python --version
          python ./.github/scripts/compose_matrix.py --compose-json compose.json --repo-root .

      - name: Show matrix
        run: |
          echo '${{ steps.gen.outputs.matrix }}' | python -m json.tool

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    if: ${{ contains(needs.generate-matrix.outputs.matrix, '"service"') }}

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} (no push)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          tags: local/${{ github.event.repository.name }}-${{ matrix.service }}:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
